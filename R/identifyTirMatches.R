#' @title
#' Identify Terminal Inverted Repeat Matches
#'
#' @description
#' Searches a \code{\link[Biostrings]{DNAStringSet}} for potential TIRs based
#' on sequence similarity.
#'
#' @param tirSeq
#' A \code{\link[Biostrings]{DNAString}} object to be searched for.
#'
#' @param Genome
#' A \code{\link[Biostrings]{DNAStringSet}} object containing the
#' \code{\link[Biostrings]{DNAString}} objects to be searched.
#'
#' @param mismatch
#' The allowable mismatch between \code{tirSeq} and a given slice of
#' \code{Genome}. Includes indels.
#'
#' @param strand
#' The directionality of the search string ("+", "-" or "*").
#'
#' @param tsdLength
#' Integer referring to the length of the flanking TSD region.
#'
#' @author
#' Jack Gisby
#'
#' @details
#' Called by \code{\link{packSearch}}. Used by \code{\link{packSearch}} as an
#' initial filtering stage. \code{\link[Biostrings]{matchPattern}} from
#' Biostrings is used for pattern matching. It is recommended to use the
#' general pipeline function \code{\link{packSearch}} for identification of
#' potential pack elements, however each stage may be called individually.
#'
#' @return
#' A dataframe, \code{tirMatches}, containing identified matches. The dataframe
#' is in the format generated by \code{\link{packSearch}}.
#'
#' @export

identifyTirMatches <- function(tirSeq,
                               Genome,
                               mismatch = 0,
                               strand = "*",
                               tsdLength) {
  if (strand != "-" & strand != "+" & strand != "*") {
    stop("Argument 'strand' must be specified as '-', '+' or '*'")
  }

  tirMatches <- data.frame(
    seqnames = factor(),
    start = integer(),
    end = integer(),
    width = integer(),
    strand = factor()
  )

  for (i in 1:length(Genome)) {
    matches <- Biostrings::matchPattern(tirSeq,
      Genome[[i]],
      max.mismatch = mismatch,
      with.indels = TRUE
    )

    if (length(matches) > 0) {
      tirMatches <- rbind(tirMatches, data.frame(
        seqnames = names(Genome)[i],
        start = matches@ranges@start,
        end = matches@ranges@start + matches@ranges@width - 1,
        width = matches@ranges@width,
        strand = strand
      ))
    }
  }
  
  if (strand == "-") {
    removeMatch <- mapply(function(end, seqnames, tsdLength, Genome) {
      return((end + tsdLength) > Genome[Genome@ranges@NAMES == seqnames][[1]]@length)
    },
    tirMatches$end,
    tirMatches$seqnames,
    MoreArgs = list(tsdLength, Genome)
    ) 
    tirMatches <- tirMatches[removeMatch == FALSE, ]
  } else if (strand == "+") {
    tirMatches <- tirMatches[tirMatches$start > tsdLength, ]
  }

  return(tirMatches)
}
